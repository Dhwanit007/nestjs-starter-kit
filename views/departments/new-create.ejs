<%- contentFor('HeaderCss') %>
    <style>
        #departmentsTable_filter {
            float: right;
        }
    </style>

    <%- contentFor('body') %>
        <div>
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Create Department</h4>
                    <a href="/departments" class="btn btn-secondary btn-sm">Back</a>
                </div>

                <div class="card-body">

                    <!-- SUCCESS / ERROR MESSAGE -->
                    <% if (message && message.text) { %>
                        <div class="alert alert-success">
                            <%= message.text %>
                        </div>
                        <% } %>

                            <% if (error && error.text) { %>
                                <div class="alert alert-danger">
                                    <%= error.text %>
                                </div>
                                <% } %>


                                    <form id="createDepartmentForm">

                                        <!-- NAME -->
                                        <div class="mb-3">
                                            <label class="form-label">Department Name <span
                                                    class="text-danger">*</span></label>
                                            <input type="text" name="name" class="form-control"
                                                placeholder="Enter department name" required>
                                        </div>

                                        <!-- DESCRIPTION -->
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea name="description" class="form-control" rows="3"
                                                placeholder="Optional description"></textarea>
                                        </div>

                                        <!-- ASSIGN EMPLOYEES -->
                                        <div class="mb-3">
                                            <label class="form-label">Assign Employees</label>
                                            <select name="assignedEmployeeIds" id="assignedEmployeeIds"
                                                class="form-control" multiple>
                                                <!-- JS will populate -->
                                            </select>
                                        </div>

                                        <button type="submit" class="btn btn-primary w-100">Create Department</button>

                                    </form>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <script>
            function loadEmployees() {
                $.ajax({
                    url: "/api/employee/newall",
                    method: "GET",
                    success: function (res) {
                        // If your API returns { data: [...] }
                        let employees = res.data || res;

                        if (!Array.isArray(employees)) {
                            console.error("Employees response is not an array", employees);
                            return;
                        }

                        let select = $("#assignedEmployeeIds");
                        select.empty();

                        employees.forEach(emp => {
                            select.append(`<option value="${emp.id}">${emp.name}</option>`);
                        });
                    },
                    error: function (err) {
                        console.error("Failed to load employees", err);
                    }
                });
            }

            loadEmployees();


            // Submit form (NO AXIOS)
            $("#createDepartmentForm").on("submit", function (e) {
                e.preventDefault();

                let payload = {
                    name: $("input[name='name']").val(),
                    description: $("textarea[name='description']").val(),
                    assignedEmployeeIds: $("#assignedEmployeeIds").val() || []
                };

                $.ajax({
                    url: "/departments/create",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function () {
                        alert("Department created successfully!");
                        window.location.href = "/departments";
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Failed to create department");
                    }
                });
            });
        </script>

        <%- contentFor('FooterJs') %>