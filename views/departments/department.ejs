<%- contentFor('HeaderCss') %>
    <style>
        #departmentsTable_filter {
            float: right;
        }
    </style>

    <%- contentFor('body') %>
        <div>
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Departments</h5>
                    <a href="/departments/create" class="btn btn-primary">+ Add Department</a>
                </div>

                <div class="card-body">
                    <table id="departmentsTable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Sr No</th>
                                <th>Department Name</th>
                                <th>Assigned Employees</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- jQuery MUST be before DataTables -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <!-- DataTables JS & CSS -->
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
        <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

        <script>
            $(document).ready(function () {
                //     $('#departmentsTable').DataTable({
                //         processing: true,
                //         serverSide: false,
                //         ajax: {
                //             url: "/departments/all",
                //             type: "GET",
                //             dataSrc: function (json) {
                //                 console.log("Server data:", json); // Check kya aa raha
                //                 return Array.isArray(json) ? json : [];
                //             }
                //         },
                //         columns: [
                //             {
                //                 data: null,
                //                 render: function (data, type, row, meta) {
                //                     return meta.row + 1; // Sr No
                //                 }
                //             },
                //             { data: "name" },
                //             {
                //                 data: "assignedEmployees",
                //                 render: function (employees) {
                //                     if (!Array.isArray(employees) || employees.length === 0) {
                //                         return `<span class="text-muted">No Employees</span>`;
                //                     }
                //                     return employees.map(e =>
                //                         `<span class="badge bg-info text-dark">${e.name}</span>`
                //                     ).join(" ");
                //                 }
                //             },
                //             {
                //                 data: "createdAt",
                //                 render: function (date) {
                //                     return new Date(date).toLocaleDateString();
                //                 }
                //             },
                //             {
                //                 data: "id",
                //                 render: function (id) {
                //                     return `
                //             <a href="/departments/edit/${id}" class="btn btn-sm btn-warning">Edit</a>
                //             <a href="/departments/delete/${id}" class="btn btn-sm btn-danger">Delete</a>
                //         `;
                //                 }
                //             }
                //         ]
                //     });
                // });
                $('#departmentsTable').DataTable({
                    processing: true,
                    serverSide: false,
                    ajax: {
                        url: "/departments/all",
                        type: "GET",
                        dataSrc: function (json) {
                            // extract the array from payload.data
                            return json.payload.data;
                        }
                    },
                    columns: [
                        {
                            data: null,
                            render: function (data, type, row, meta) {
                                return meta.row + 1;
                            }
                        },
                        { data: "name" },
                        {
                            data: "assignedEmployees",
                            render: function (employees) {
                                if (!employees || employees.length === 0) {
                                    return `<span class="text-muted">No Employees</span>`;
                                }
                                return employees.map(e =>
                                    `<span class="badge bg-info text-dark">${e.name}</span>`
                                ).join(" ");
                            }
                        },
                        {
                            data: "createdAt",
                            render: function (date) {
                                return new Date(date).toLocaleDateString();
                            }
                        },
                        {
                            data: "id",
                            render: function (id) {
                                return `
                    <a href="/departments/edit/${id}" class="btn btn-sm btn-warning">Edit</a>
                    <a href="/departments/delete/${id}" class="btn btn-sm btn-danger">Delete</a>
                `;
                            }
                        }
                    ]
                });

            })    </script>

        <%- contentFor('FooterJs') %>